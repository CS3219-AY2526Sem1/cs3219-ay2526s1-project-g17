# Question Service Design Documentation

## Architecture Overview

The Question Service is a microservice within the PeerPrep application that manages coding questions. It follows a layered architecture pattern with clear separation of concerns across routes, controllers, models, and middleware layers.

**Service Type:** RESTful API microservice  
**Runtime:** Node.js 22  
**Framework:** Express 5.1.0  
**Database:** MongoDB Atlas (NoSQL)  
**Deployment:** Docker containers, Google Cloud Run  

## System Architecture

### Layered Architecture

```
Client Request
    |
    v
Routes Layer (questionsRoutes.js)
    |
    v
Middleware Layer (Authentication)
    |
    v
Controller Layer (questionsController.js)
    |
    v
Model Layer (Question.js)
    |
    v
Database (MongoDB Atlas)
```

### Component Responsibilities

**Routes Layer:**
- Maps HTTP methods and paths to controller functions
- Applies middleware to protected routes
- Handles route ordering (specific routes before dynamic parameters)

**Middleware Layer:**
- Authentication: Validates JWT tokens from Auth0
- Authorization: Checks for required permissions (admin role)
- Error Handling: Catches and formats errors

**Controller Layer:**
- Processes request data
- Executes business logic
- Interacts with database through Mongoose models
- Formats and sends responses

**Model Layer:**
- Defines data schema and validation rules
- Manages database indexes
- Provides abstraction over MongoDB operations

## Database Design

### Database Selection: MongoDB Atlas

**Rationale for NoSQL:**

1. **Schema Flexibility:** Questions may have varying optional fields (testCases, hints, solution). NoSQL allows easy addition of new fields without schema migrations.

2. **Horizontal Scalability:** As the question database grows, MongoDB Atlas automatically distributes load across servers.

3. **No Complex Relationships:** Questions are self-contained documents with no foreign key relationships, eliminating the need for SQL joins.

4. **Document Model:** Questions naturally map to JSON documents, simplifying API responses and reducing impedance mismatch.

5. **Performance:** For read-heavy workloads (fetching questions), MongoDB's document retrieval is efficient.

### Question Schema

```javascript
{
  title: String (required),
  question: String (required),
  difficulty: String (required, enum: ['Beginner', 'Intermediate', 'Advanced']),
  topics: [String] (required),
  testCases: [String] (optional),
  constraints: String (optional),
  hints: String (optional),
  solution: String (optional),
  createdAt: Date (auto-generated by timestamps),
  updatedAt: Date (auto-generated by timestamps)
}
```

### Indexing Strategy

**Compound Index:**
```javascript
questionSchema.index({ difficulty: 1, topics: 1 });
```

**Purpose:**
- Optimizes the `getRandomQuestionIdByDifficultyAndTopic` endpoint
- Supports queries that filter by both difficulty and topics simultaneously
- Uses ascending order (1) for both fields

## API Design

### RESTful Principles

The API follows REST conventions:
- **Resources:** Questions are the primary resource
- **HTTP Methods:** GET (read), POST (create), PUT (update), DELETE (remove)
- **Stateless:** Each request contains all necessary information
- **JSON Format:** All requests and responses use JSON

## Authentication and Authorization

### Auth0 Integration

**Authentication Flow:**
1. User logs in through frontend Auth0 widget
2. Auth0 issues JWT access token with user claims
3. Frontend includes token in `Authorization: Bearer <token>` header
4. Service validates token using `express-oauth2-jwt-bearer` middleware
5. Middleware decodes token and verifies signature against Auth0 public keys

**Authorization Model:**
- **Public Endpoints:** Read operations (GET) do not require authentication
- **Admin Endpoints:** Write operations (POST, PUT, DELETE) require `admin:all` permission
- **Permission Check:** Custom middleware `checkRequiredPermissions` validates token claims

**Security Considerations:**
- Tokens are short-lived (typically 1 hour expiration)
- Token validation is stateless (no database lookup)
- Public key rotation is handled automatically by Auth0 and middleware
- HTTPS enforced in production to prevent token interception

### Middleware Stack

**Protected Route Example:**
```javascript
router.post("/", 
  verifyAccessToken,                    // Validates JWT
  checkRequiredPermissions(['admin:all']),  // Checks permissions
  createQuestion                        // Controller function
);
```

**Middleware Execution Order:**
1. CORS (if configured)
2. Body parser (built into Express 5)
3. Custom authentication middleware
4. Custom authorization middleware
5. Controller function

## Error Handling

### Consistent Error Responses

All errors return JSON with `message` field:
```json
{
  "message": "Error description"
}
```

### Error Categories

**Client Errors (4xx):**
- `400 Bad Request`: Invalid request body or parameters
- `401 Unauthorized`: Missing or invalid authentication token
- `403 Forbidden`: Valid token but insufficient permissions
- `404 Not Found`: Resource does not exist
- `429 Too Many Requests`: Rate limit exceeded

**Server Errors (5xx):**
- `500 Internal Server Error`: Unexpected errors caught in try-catch blocks

## Containerization

### Docker Strategy

**Base Image: node:22-alpine**

**Rationale:**
1. **Size:** Alpine Linux is minimal (5MB base vs 200MB+ for full Debian)
2. **Security:** Smaller attack surface, fewer installed packages
3. **Performance:** Faster build times, faster deployment, less storage
4. **Node 22:** Latest LTS version with performance improvements and security patches

### CI/CD Testing

**GitHub Actions Workflow:**
- Runs on push/PR to master branch
- Executes `npm test` before Docker build
- Fails deployment if tests fail
- Caches `node_modules` for faster builds

## Service Integration

### PeerPrep System Context

The Question Service is one microservice in the PeerPrep application:

**Dependent Services:**
- **Frontend:** Consumes Question Service API to display questions to users
- **Matching Service:** Calls `getRandomQuestionIdByDifficultyAndTopic` to assign questions to matched pairs
- **History Service:** Records which questions users have completed

**Service Communication:**
- **Synchronous:** REST API calls over HTTP
- **Service Discovery:** Services communicate via environment-configured URLs
- **Docker Compose:** Local development uses service names for DNS resolution

## Performance Considerations

### Query Performance

**Indexing:**
- Compound index on `{difficulty: 1, topics: 1}` speeds up random question queries
- Single-document lookups by `_id` use MongoDB's default index

**Aggregation Pipelines:**
- `getAllTopics`: Efficient server-side processing reduces network transfer
- `getRandomQuestionIdByDifficultyAndTopic`: Index-backed `$match` stage

**Caching Opportunities (Future Enhancement):**
- Cache `getAllTopics` response (topics change infrequently)
- Cache `getListOfTopicsByDifficulty` response
- Use Redis or in-memory cache with TTL
- Invalidate cache on question creation/update/deletion

### Scalability

**Horizontal Scaling:**
- Stateless service allows multiple instances behind load balancer
- MongoDB Atlas handles database scaling automatically
- No session state or in-memory data structures

**Database Connection Pooling:**
- Mongoose maintains connection pool by default
- Reuses connections across requests
- Configure pool size based on load

**Load Testing Considerations:**
- Monitor response times under concurrent requests
- Test database query performance with large datasets
- Identify bottlenecks (database, CPU, network)

## Technology Decisions Summary

| Component | Technology | Rationale |
|-----------|-----------|-----------|
| Runtime | Node.js 22 | Latest LTS, async I/O for high concurrency |
| Framework | Express 5.1.0 | Mature, lightweight, extensive middleware ecosystem |
| Database | MongoDB Atlas | NoSQL flexibility, horizontal scaling, document model |
| Authentication | Auth0 | Managed identity provider, reduces security complexity |
| Testing | Jest 29.7.0 | Feature-rich, ES module support, mocking capabilities |
| Containerization | Docker + Alpine | Lightweight images, fast deployments, consistency |
| Orchestration | Docker Compose | Local multi-service development, simple configuration |
| CI/CD | GitHub Actions | Native GitHub integration, free for public repos |
| Cloud Platform | Google Cloud Run | Serverless, auto-scaling, pay-per-request |

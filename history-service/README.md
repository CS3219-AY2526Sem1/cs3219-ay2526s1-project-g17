# History Service

Lightweight Express service that persists users' coding attempts and exposes them via a REST API. Data is stored in MongoDB using Mongoose models.

## Prerequisites
- Node.js 18+ and npm
- Accessible MongoDB connection string
- Upstash Redis REST URL and token (used by the rate limiter)

## Installation & Local Development
1. Install dependencies:
   ```bash
   npm install
   ```
2. Configure environment variables (see below).
3. Start the service:
   ```bash
   npm run dev     # nodemon
   # or
   npm start       # plain node
   ```
4. The server listens on `PORT` (defaults to `3004`) and mounts routes under `/history`.

## Environment Variables
Define these in `history-service/.env` (see `.env` sample in the repo):

| Variable | Required | Description |
| --- | --- | --- |
| `MONGO_URI` | ✅ | MongoDB connection string targeting the history database. |
| `PORT` | ➖ | Port for the Express server (defaults to `3004`). |
| `UPSTASH_REDIS_REST_URL` | ✅ | Upstash Redis REST endpoint used by the rate limiter middleware. |
| `UPSTASH_REDIS_REST_TOKEN` | ✅ | Token associated with the Upstash Redis instance. |

## API Endpoints
All endpoints are prefixed with `/history`. Responses use JSON.

### `GET /history/:userId`
- **Purpose:** Retrieve a user's question attempts sorted by newest first.
- **Route handler:** `getUsersHistory` (`src/controller/historyController.js`)
- **URL params:** `userId` (string, required)
- **Query params (optional):**
  - `limit` (number, defaults to `10`) — max results to return.
  - `skip` (number, defaults to `0`) — number of records to skip for pagination.
- **Headers:**
  - Required: Authorization: Bearer <JWT_ACCESS_TOKEN>
  - Auth Rules: 
      - User: Can receive their own data
- **Responses:**
  - `200 OK` with:
    ```json
    {
      "userId": "123",
      "count": 2,
      "attempts": [
        {
          "_id": "670...",
          "userId": "123",
          "questionId": "leetcode-two-sum",
          "submissionCode": "function twoSum(...) { ... }",
          "timestamp": "2024-09-24T10:15:00.123Z",
          "createdAt": "2024-09-24T10:15:00.123Z",
          "updatedAt": "2024-09-24T10:15:00.123Z",
          "__v": 0
        }
      ]
    }
    ```
  - `404 Not Found` when the user has no attempts.
  - `500 Internal Server Error` on unexpected failures.

### `POST /history/create-attempt`
- **Purpose:** Persist a new question attempt.
- **Route handler:** `createAttempt`
- **Request body (JSON):**
  ```json
  {
    "userId": "123",            // required
    "questionId": "leetcode-two-sum", // required
    "submissionCode": "function twoSum(...) { ... }"
  }
  ```
- **Responses:**
  - `201 Created` with `{ "savedAttempt": { ...attempt document... } }`.
  - `500 Internal Server Error` if persistence fails.

### `PUT /history/update-attempt/:id`
- **Purpose:** Update an existing attempt document by Mongo `_id`.
- **Route handler:** `updateAttempt`
- **URL params:** `id` (string, required) — MongoDB document `_id`.
- **Request body (JSON):**
  ```json
  {
    "attemptId": "optional external id",
    "userId": "123",
    "questionId": "leetcode-two-sum",
    "submissionCode": "updated code"
  }
  ```
- **Responses:**
  - `200 OK` with the updated attempt document.
  - `404 Not Found` if no attempt matches the provided `id`.
  - `500 Internal Server Error` on unexpected failures.

## Data Model
Attempts are stored using the `QuestionAttempt` schema (`src/models/Attempt.js`):
- `userId` *(string, required)* — owner of the attempt.
- `questionId` *(string, required)* — identifier of the question attempted.
- `submissionCode` *(string)* — latest code submission.
- `timestamp` *(Date, default now)* — stored alongside autogenerated `createdAt` / `updatedAt`.
- Indexed fields support fast lookups by user, question, and recency.

## Additional Notes
- Cross-origin requests are allowed via the `cors` middleware by default.
